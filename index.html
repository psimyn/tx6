<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TX-6 Bluetooth Control</title>
    <meta property="og:title" content="TX-6 Remote">
    <meta property="og:description" content="Control TX-6 with Bluetooth or USB">
    <meta property="og:image" content="https://tx6.psimyn.com/tx6-og-1200.jpg">
    <meta name="theme-color" content="#e2e2e4">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" href="/icon-192.png">
    <script type="module" src="/src/main.js"></script>
</head>

<body x-data="tx6Controller()" x-init="init()">
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-bar-header">
            <h1 class="app-title">tx6-ctl</h1>
            <div class="options-menu-wrapper">
                <button class="options-button" @click="showOptionsMenu = !showOptionsMenu">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="1"></circle>
                        <circle cx="12" cy="5" r="1"></circle>
                        <circle cx="12" cy="19" r="1"></circle>
                    </svg>
                </button>
                <div class="options-dropdown" x-show="showOptionsMenu" @click.away="showOptionsMenu = false" x-transition>
                    <button class="dropdown-item" @click="currentView = 'help'; showOptionsMenu = false">Help</button>
                    <button class="dropdown-item" @click="currentView = 'about'; showOptionsMenu = false">About</button>
                </div>
            </div>
        </div>
        <!-- Tab Navigation -->
        <nav class="tab-navigation">
            <button class="tab-button" :class="{ active: currentView === 'main' }" @click="switchView('main')">MAIN</button>
            <button class="tab-button" :class="{ active: currentView === 'fx' }" @click="switchView('fx')">FX</button>
            <button class="tab-button" :class="{ active: currentView === 'synth' }" @click="switchView('synth')">SYNTH</button>
            <button class="tab-button" :class="{ active: currentView === 'lfo' }" @click="switchView('lfo')">LFO</button>
        </nav>
    </div>

    <!-- Shared Header -->
    <header class="app-header" x-show="currentView !== 'help' && currentView !== 'about'">
        <div class="status" x-show="status" x-text="status"></div>
        <div class="connection-buttons">
            <template x-for="type in ['ble', 'usb']">
                <button @click="connect(type)" class="connect-btn" x-show="!isConnected" :disabled="connecting"
                    x-text="`Connect ${type === 'ble' ? 'BLE' : 'USB'}`">
                </button>
            </template>
        </div>
        <div class="track-selector">
            <template x-for="i in 6" :key="i">
                <button class="track-button" :class="{ active: currentTrack === i-1 }" @click="selectTrack(i-1)"
                    x-text="`T${i}`">
                </button>
            </template>
        </div>
    </header>

    <!-- Main View -->
    <div class="view-container knob-container" x-show="currentView === 'main'">

        <div class="knob-wrapper">
            <div class="volume-slider">
                <input type="range" min="0" max="127" :value="sliderValue" @input="handleSliderChange($event)" @wheel="event.preventDefault()">
                <input type="range" min="0" max="127" x-model="sliderOutputValue" class="slider-overlay" readonly
                    tabindex="-1" @wheel="event.preventDefault()">
            </div>
            <div class="value-display">
                <span class="knob-value value-large" x-text="Math.floor(sliderValue * 100 / 127)"></span>
            </div>
        </div>

            <div class="knob-wrapper">
                <div x-data="knob(knobConfigs.eq)" class="knob" @mousedown="startDrag($event)"
                    @touchstart="startDrag($event)" x-init="knobData.value = knobs.eq.value" x-effect="knobData.value = knobs.eq.value">
                    <div class="knob-indicator indicator-small"
                        :style="`background: ${eqIndicatorColor}; transform: translateX(-50%) rotate(${midiToAngle(knobData.value)}deg)`">
                    </div>
                </div>
                <div class="value-display">
                    <select x-model="currentEqMode" @change="selectEqMode($event.target.value)" class="mode-select">
                        <template x-for="option in eqDropdownOptions">
                            <option :value="option.value" x-text="`${option.label}  ${option.displayValue}`"></option>
                        </template>
                    </select>
                </div>
            </div>
            <div class="knob-wrapper">
                <div x-data="knob(knobConfigs.fx1)" class="knob" @mousedown="startDrag($event)"
                    @touchstart="startDrag($event)" x-init="knobData.value = knobs.fx1.value" x-effect="knobData.value = knobs.fx1.value">
                    <div class="knob-indicator indicator-small"
                        :style="`background: var(--accent-color-orange); transform: translateX(-50%) rotate(${midiToAngle(knobData.value)}deg)`">
                    </div>
                </div>
                <div class="value-display">
                    <select x-model="currentFxMode" @change="selectFxMode($event.target.value)" class="mode-select">
                        <template x-for="option in fx1DropdownOptions">
                            <option :value="option.value" x-text="`${option.label}  ${option.displayValue}`"></option>
                        </template>
                    </select>
                </div>
            </div>

        <!-- Master Channel Radio Group -->
        <div class="master-channel-section">
            <div class="master-channel-radio-group">
                <label class="master-channel-radio-label">
                    <input type="radio" name="master-channel" value="aux" x-model="masterChannel" class="master-channel-radio">
                    <span>AUX</span>
                </label>
                <label class="master-channel-radio-label">
                    <input type="radio" name="master-channel" value="cue" x-model="masterChannel" class="master-channel-radio">
                    <span>CUE</span>
                </label>
                <label class="master-channel-radio-label">
                    <input type="radio" name="master-channel" value="volume" x-model="masterChannel" class="master-channel-radio">
                    <span>MASTER</span>
                </label>
            </div>
        </div>

        <!-- Master knob -->
        <div class="knob-wrapper main-knob">
            <div x-data="knob(knobConfigs.masterVolume)" class="knob" @mousedown="startDrag($event)"
                @touchstart="startDrag($event)" x-init="knobData.value = knobs.masterVolume.value"
                x-effect="knobData.value = knobs.masterVolume.value">
                <div class="knob-indicator indicator-small"
                    :style="`transform: translateX(-50%) rotate(${midiToAngle(knobData.value)}deg)`">
                </div>
            </div>
            <div class="value-display">
                <span class="knob-value" x-text="Math.floor(knobs.masterVolume.value * 100 / 127)"></span>
                <span class="knob-label" x-text="masterChannelLabel"></span>
            </div>
        </div>
    </div>

    <!-- FX View -->
    <div class="view-container fx-view-container" x-show="currentView === 'fx'">
        <div class="view-content">
            <!-- FX Channel Selector -->
            <div>
                <template x-for="ch in [7, 8]">
                    <button class="fx-channel-button" :class="{ active: fx.currentChannel === ch }"
                        @click="fx.currentChannel = ch; updateFxDisplay()" 
                        x-text="`FX ${ch === 7 ? 'I' : 'II'}`">
                    </button>
                </template>
            </div>

            <!-- FX Engine Select -->
            <div class="fx-engine-section">
                <label class="knob-label">Engine</label>
                <div class="fx-engine-radio-group">
                    <template x-for="(option, index) in fx.channels[fx.currentChannel].types" :key="index">
                        <label class="fx-engine-radio-label">
                            <input type="radio" 
                                :name="`fx-engine-${fx.currentChannel}`"
                                :value="calculateMidiValue(index, fx.channels[fx.currentChannel].types.length)"
                                x-model="fx.channels[fx.currentChannel].engine"
                                @change="handleFxEngineChange()"
                                class="fx-engine-radio">
                            <span x-text="option"></span>
                        </label>
                    </template>
                </div>
            </div>

            <!-- FX Parameters Knobs -->
            <div class="fx-knobs-grid">
                <template x-for="knobId in ['fxReturn', 'fxParam1', 'fxParam2']">
                    <div class="knob-wrapper" x-show="knobId !== 'fxParam2' || fxParam2Visibility">
                        <div x-data="knob(knobConfigs[knobId])" class="knob" @mousedown="startDrag($event)"
                            @touchstart="startDrag($event)" x-init="knobData.value = knobs[knobId].value"
                            x-effect="knobData.value = knobs[knobId].value">
                            <div class="knob-indicator indicator-small"
                                :style="`transform: translateX(-50%) rotate(${midiToAngle(knobData.value)}deg)`">
                            </div>
                        </div>
                        <div class="value-display">
                            <span class="knob-value" x-text="getKnobDisplayValue(knobId)"></span>
                            <span class="knob-label" x-text="getKnobLabel(knobId)"></span>
                        </div>
                    </div>
                </template>
            </div>

            <!-- FX Toggle Buttons -->
            <div class="fx-toggle-section">
                <label class="knob-label">Enable FX</label>
                <div class="fx-toggle-buttons">
                    <template x-for="i in 2">
                        <button @click="toggleFx(i)" class="fx-button"
                            :class="{ active: fx[`fx${i}Active`], orange: i === 2 }">
                            <span class="fx-button-inner" x-text="`FX${i}`"></span>
                        </button>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- LFO View -->
    <div class="view-container" x-show="currentView === 'lfo'">
        <div class="view-content">
            <div style="position:relative;display:flex;flex-direction:column;align-items:flex-start;gap:1rem;">
                <div class="knob-wrapper">
                    <div class="flex gap-1">
                        <select x-model="currentLfoIndex" @change="updateLfoKnobs()" class="fx-engine-select"
                            style="min-width:80px;">
                            <template x-for="i in 10">
                                <option :value="i-1" x-text="`LFO ${i}`"></option>
                            </template>
                        </select>
                        <select x-model="globalLfos[currentLfoIndex].target" class="fx-engine-select">
                            <option value="vol">VOL</option>
                            <option value="aux">AUX</option>
                            <option value="flt">FLT</option>
                        </select>
                        <select x-model="globalLfos[currentLfoIndex].assignedTrack" class="fx-engine-select">
                            <template x-for="i in 6">
                                <option :value="i-1" x-text="`T${i}`"></option>
                            </template>
                        </select>
                    </div>
                </div>

                <div style="display:flex;align-items:center;gap:1rem;position:relative;">
                    <select x-model="globalLfos[currentLfoIndex].shape" class="fx-engine-select lfo-shape"
                        @change="$nextTick(() => drawLfoWaveform())" style="writing-mode:horizontal-tb;">
                        <template x-for="shape in ['sine', 'triangle', 'square', 'saw', 'revsaw', 'noise']">
                            <option :value="shape" x-text="shape.charAt(0).toUpperCase() + shape.slice(1)"></option>
                        </template>
                    </select>
                    <canvas id="lfo-canvas" width="300" height="100"
                        style="border: 1px solid var(--knob-border); border-radius: 4px;"></canvas>
                </div>

                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;justify-items:center;">
                    <template x-for="lfoKnob in ['lfoRate', 'lfoAmount', 'lfoPhase']">
                        <div class="knob-wrapper">
                            <label class="knob-label" x-text="lfoKnob.replace('lfo', '').toUpperCase()"></label>
                            <div x-data="knob(knobConfigs[lfoKnob])" class="knob" @mousedown="startDrag($event)"
                                @touchstart="startDrag($event)"
                                x-init="knobData.value = globalLfos[currentLfoIndex][lfoKnob.replace('lfo', '').toLowerCase()]"
                                x-effect="knobData.value = globalLfos[currentLfoIndex][lfoKnob.replace('lfo', '').toLowerCase()]">
                                <div class="knob-indicator indicator-small"
                                    :style="`transform: translateX(-50%) rotate(${getKnobAngle(lfoKnob, knobData.value)}deg)`">
                                </div>
                            </div>
                            <div class="value-display">
                                <span class="knob-value" x-text="getLfoKnobDisplay(lfoKnob)"></span>
                                <span class="knob-label" x-text="getLfoKnobUnit(lfoKnob)"></span>
                            </div>
                            <div class="rate-buttons" x-show="lfoKnob === 'lfoRate'">
                                <template x-for="mult in [0.25, 0.5, 1/3, 1, 2, 4]">
                                    <button @click="setLfoRateFromBpm(mult)" class="rate-button"
                                        :class="{ 'active': isRateButtonActive(mult) }"
                                        x-text="getRateButtonLabel(mult)">
                                    </button>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Transport Controls -->
                <div class="lfo-transport-section">
                    <h3 class="knob-label">Transport</h3>
                    <div class="lfo-transport-controls">
                        <div class="knob-wrapper">
                            <div>
                                <input x-model.number="bpm" @change="updateBpm()" @focus="$event.target.select()" class="bpm-input"
                                    min="40" max="400">
                                <div class="knob-label">BPM</div>
                            </div>
                        </div>

                        <button @click="togglePlay()" class="start-stop-button" :class="{ active: startStopActive }">
                            <svg class="play-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 5v14l11-7z" />
                            </svg>
                            <svg class="stop-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M6 6h12v12H6z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Synth View -->
    <div class="view-container" x-show="currentView === 'synth'">
        <div class="view-content">
            <div style="position:relative;display:flex;flex-direction:column;align-items:flex-start;gap:1rem;">
                <div class="synth-controls">
                    <div class="synth-input-wrapper" style="display: flex; align-items: center; gap: 1rem;">
                        <div>
                            <label class="knob-label">SEQ</label>
                            <input type="number" min="0" max="29" x-model="synthSettings.seq" @input="handleSeqChange()"
                  class="seq-input" placeholder="0-29">
                        </div>
                        <div class="seq-preview-grid" x-show="synthSettings.seq !== null && synthSettings.seq !== ''">
                            <template x-for="row in 2">
                                <div class="seq-preview-row" style="display: flex; gap: 2px;">
                                    <template x-for="col in 8">
                                        <div class="seq-preview-cell"
                                            :class="{ 'active': getSeqPreviewCell(row-1, col-1) }"
                                            style="width: 8px; height: 8px; border: 1px solid var(--knob-border); background: var(--background-color);">
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;justify-items:center;">
                        <div class="knob-wrapper">
                            <label class="knob-label">WAVE</label>
                            <select x-model="synthSettings.waveform" @change="handleWaveformChange()"
                                class="fx-engine-select">
                                <template x-for="(opt, i) in waveformLabels">
                                    <option :value="i * 14" x-text="opt"></option>
                                </template>
                            </select>
                        </div>

                        <template x-for="synthKnob in ['synthFreq', 'synthLen']">
                            <div class="knob-wrapper">
                                <label class="knob-label" x-text="synthKnob === 'synthFreq' ? 'FREQ' : 'LEN'"></label>
                                <div x-data="knob(knobConfigs[synthKnob])" class="knob" @mousedown="startDrag($event)"
                                    @touchstart="startDrag($event)" x-init="knobData.value = knobs[synthKnob].value"
                                    x-effect="knobData.value = knobs[synthKnob].value">
                                    <div class="knob-indicator indicator-small"
                                        :style="`transform: translateX(-50%) rotate(${synthKnob === 'synthFreq' ? synthFreqToAngle(knobData.value) : midiToAngle(knobData.value)}deg)`">
                                    </div>
                                </div>
                                <div class="value-display">
                                    <span class="knob-value"
                                        x-text="synthKnob === 'synthFreq' ? synthFreqDisplayValue : Math.floor(knobs[synthKnob].value * 100 / 127)"></span>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Keyboard -->
                    <div class="keyboard-section">
                        <div class="keyboard-controls">
                            <button @click="decreaseOctave()" class="octave-button">-</button>
                            <span class="octave-display" x-text="synthSettings.octave"></span>
                            <button @click="increaseOctave()" class="octave-button">+</button>
                        </div>
                        <div class="keyboard">
                            <template x-for="(note, index) in keyboardNotes" :key="index">
                                <button 
                                    @click="playNote(note)"
                                    class="key"
                                    :class="{ 'black-key': note.isBlack, 'disabled': note.isDisabled }"
                                    :style="note.isBlack ? `left: ${note.position}%` : ''"
                                    :disabled="note.isDisabled"
                                    x-text="note.isBlack ? '' : note.label">
                                </button>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Help View -->
    <div class="view-container info-view" x-show="currentView === 'help'">
        <div class="view-content">
            <h2 class="view-title">Help</h2>
            <div class="info-text">
                <p>Connect Bluetooth or USB to get started.</p>
                <p>Make sure your TX-6 has MIDI CTRL IN enabled, and BLE set to ACCEPT (if needed)</p>
                
                <h3>Main</h3>
                <ul>
                    <li>Select track (T1-T6) from top row</li>
                    <li>knob 1 controls filter and EQ</li>
                    <li>Master knob controls aux, cue, or master volume</li>
                </ul>
                
                <h3>FX</h3>
                <ul>
                    <li>Switch between FX I/II, select engine, adjust parameters</li>
                </ul>
                
                <h3>LFO</h3>
                <p>Note: these only work while play is pressed</p>
                <ul>
                    <li>Configure 10 LFOs with waveform, rate, amount, phase</li>
                    <li>Control BPM and transport (play/stop)</li>
                </ul>
                
                <h3>Synth</h3>
                <ul>
                    <li>Set sequence pattern, waveform, frequency, and length</li>
                </ul>
            </div>
            <button @click="currentView = 'main'" class="back-button">Back</button>
        </div>
    </div>

    <!-- About View -->
    <div class="view-container info-view" x-show="currentView === 'about'">
        <div class="view-content">
            <h2 class="view-title">About</h2>
            <div class="info-text">
                <p>Remote control for your TX-6. Control with Bluetooth or USB.</p>
                
                <h3>Features</h3>
                <ul>
                    <li>10 assignable LFOs for params</li>
                    <li>Per-track volume, FX, and EQ control</li>
                    <li>Synth sequencer config</li>
                    <li>Control FX settings</li>
                </ul>
            </div>
            <button @click="currentView = 'main'" class="back-button">Back</button>
        </div>
    </div>

    <button class="fullscreen-toggle-btn" @click="toggleFullscreen()" x-show="!isFullscreen" title="Enter fullscreen">
        <span>â›¶</span>
    </button>

</body>

</html>
